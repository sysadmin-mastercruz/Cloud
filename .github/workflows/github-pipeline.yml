name: CI com Trivy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: api-projeto
      IMAGE_TAG: v1
      REGISTRY: ghcr.io/${{ github.repository }}

    steps:
    # 📥 Clonar o repositório
    - name: Checkout do código
      uses: actions/checkout@v3

    # 🐍 Instalar Python e dependências
    - name: Instalar Python e dependências
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Instalar dependências do projeto
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest

    # 🧪 Linting
    - name: Verificar estilo com flake8
      run: flake8 app || true

    # ✅ Testes unitários
    - name: Executar testes com pytest
      run: pytest || echo "Sem testes definidos"

    # 🐳 Build da imagem Docker
    - name: Construir imagem Docker
      run: |
        docker build -t $IMAGE_NAME:$IMAGE_TAG .

    # 🔍 Instalar Trivy (versão correta)
    - name: Instalar Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/download/v0.62.1/trivy_0.62.1_Linux-64bit.deb
        sudo dpkg -i trivy_0.62.1_Linux-64bit.deb

    # 🛡️ Scan da imagem Docker com Trivy
    - name: Analisar imagem Docker com Trivy
      run: |
        trivy image $IMAGE_NAME:$IMAGE_TAG || true

    # 🧬 Scan do código-fonte com Trivy
    - name: Analisar código-fonte com Trivy
      run: |
        trivy fs . || true
